name: Release

on:
  push:
    tags: ["[0-9]+.[0-9]+*"]

env:
  executable: example

jobs:
  build:
    name: Build
    uses: ./.github/workflows/build.yml

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Get tag
        id: tag
        uses: dawidd6/action-get-tag@v1

      - name: Download
        uses: actions/download-artifact@v3
        with:
          path: ./builds

      - name: Package (Linux)
        run: |
          tar -czf ${{ env.executable }}_linux.tar.gz builds/linux/*

      - name: Upload (Linux)
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ${{ env.executable }}_linux.tar.gz
          asset_name: ${{ env.executable }}_${{ steps.tag.outputs.tag }}_linux.tar.gz
          tag: ${{ github.ref }}
          overwrite: true

      - name: Package (macOS)
        run: |
          tar -czf ${{ env.executable }}_macos.tar.gz builds/macos/*

      - name: Upload (macOS)
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: builds/macos/${{ env.executable }}.dmg
          asset_name: ${{ env.executable }}_${{ steps.tag.outputs.tag }}_macos.dmg
          tag: ${{ github.ref }}
          overwrite: true

      - name: Package (Windows)
        uses: vimtor/action-zip@v1
        with:
          files: builds/windows
          recursive: false
          dest: ${{ env.executable }}_windows.zip

      - name: Upload (Windows)
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ${{ env.executable }}_windows.zip
          asset_name: ${{ env.executable }}_${{ steps.tag.outputs.tag }}_windows.zip
          tag: ${{ github.ref }}
          overwrite: true
